<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kakao Map</title>
    <style>
        @font-face{
            font-family: 'GangwonEdu_OTFBoldA';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2201-2@1.0/GangwonEdu_OTFBoldA.woff')format('woff');
            font-weight: normal;
            font-style: normal;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'GangwonEdu_OTFBoldA', sans-serif;
        }
        body{
            display: flex;
            flex-direction: column;
        }
        #topBar {
            width: 100%;
            /* background-color: #2b0670; */

            color: rgb(255, 254, 195);
            padding: 30px;
            font-size: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            background-image: url(https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTWtsDB1VtXgpKD5G9XuwTryjr8zgwESC0iSUYwuaDzQuPEv_nz);
            
        
        }

        #topBar button {
            background-color: #ff5722; /* 버튼 배경색 */
            color: white;
            border: none;
            padding: 30px 50px;
            cursor: pointer;
            font-size: 20px;
        }

        #map {
            flex: 1;
            width: 100%;
            height: 100%;
        }

        #userInfo {
            font-weight: bold;
            margin-bottom: 10px;
            display: none;
        }

        
        
    </style>
</head>
<body>
    <div id="topBar">
        <div>Title</div>
        <button id="myButton">Click Me</button>
    </div>
    <div id="userInfo"></div>
    <div id="map"></div>
    <div id="clickLatlng"></div>
    <input type="text" id="markerText" placeholder="마커에 표시할 텍스트를 입력하세요">
    <!--USERNAME-->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ce088c9e60f0aa7b15b277e55acb4149"></script>
    <script>
        var username = null; // 로그인 이름과 동적 연결

        document.addEventListener('DOMContentLoaded', function () {
            fetch('/get-username')
                .then(response => response.json())
                .then(data => {
                    if (data.username) {
                        console.log("Logged in as:", data.username);
                        username = data.username;
                        initializeMap(); // username이 정의된 후 initializeMap 호출
                        initializeChat();
                    }
                })
                .catch(error => console.error('Error fetching username:', error));
        });

        // WebSocket 연결 초기화
        var socket = new WebSocket(`wss://${window.location.host}`);

        socket.onopen = function () {
            console.log('WebSocket 연결 성공');
        };

        socket.onerror = function (error) {
            console.log('WebSocket 에러:', error);
        };

        socket.onclose = function () {
            console.log('WebSocket 연결 종료');
        };

        let userMarkers = {};
        let userInfoWindows = {};

        socket.onmessage = function (event) {
            const message = JSON.parse(event.data);
            if (message.action === 'updateUserLocations') {
                updateUserMarkers(message.userLocations);
            } else if (message.action === 'removeMarker') {
                removeUserMarker(message.username, message.latitude, message.longitude);
            } else if (message.action === 'addMarker') {
                addMarker(message.latitude, message.longitude, message.username, message.userText);
            }
        };

        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };
        var map = new kakao.maps.Map(container, options);
        var marker = null;
        var infowindow = null;

        console.log('로그인한 사용자:', username);

        var userInfoDiv = document.getElementById('userInfo');
        userInfo.textContent = username + '님이 접속했습니다.';

        let userLatitude = 0.0;
        let userLongitude = 0.0;

        function initializeMap() {
            getUserGeoData()
                .then(([latitude, longitude]) => {
                    userLatitude = latitude;
                    userLongitude = longitude;
                    console.log(`Initial Latitude: ${userLatitude}, Longitude: ${userLongitude}`);

                    map.setCenter(new kakao.maps.LatLng(userLatitude, userLongitude));

                    if (username) {
                        addOrUpdateUserMarker(username, userLatitude, userLongitude);
                    }

                    setInterval(updateUserLocation, 5000);
                })
                .catch((error) => {
                    console.error(error);
                });
        }

        function addOrUpdateUserMarker(username, latitude, longitude) {
            if (userMarkers[username]) {
                userMarkers[username].setPosition(new kakao.maps.LatLng(latitude, longitude));
            } else {
                userMarkers[username] = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(latitude, longitude),
                    map: map
                });

                var iwContent = `<div id="${username}-popup"><strong>${username}'s location</strong><br><div class="messages"></div></div>`;
                var infowindow = new kakao.maps.InfoWindow({
                    content: iwContent,
                    removable: true
                });
                infowindow.open(map, userMarkers[username]);
            }
        }

        function updateUserMarkers(userLocations) {
            userLocations.forEach(userLocation => {
                addOrUpdateUserMarker(userLocation.username, userLocation.latitude, userLocation.longitude);
            });
        }

        function removeUserMarker(username, latitude, longitude) {
            const key = `${username}_${latitude}_${longitude}`;
            if (userMarkers[key]) {
                userMarkers[key].setMap(null);
                delete userMarkers[key];
            }
            if (userInfoWindows[key]) {
                userInfoWindows[key].close();
                delete userInfoWindows[key];
            }
        }

        function sendLocation(latitude, longitude) {
            if (socket.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    action: 'updateLocation',
                    username: username,
                    latitude: latitude,
                    longitude: longitude
                });
                socket.send(message);
                console.log('위치 데이터 전송:', message);
            } else {
                console.log("WebSocket이 열려있지 않습니다.");
            }
        }

        function updateUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    if (username) {
                        sendLocation(latitude, longitude);
                    }
                }, error => {
                    console.error('위치 정보 에러:', error);
                });
            } else {
                console.error('이 브라우저에서는 위치 정보를 지원하지 않습니다.');
            }
        }

        function getUserGeoData() {
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const latitude = position.coords.latitude;
                            const longitude = position.coords.longitude;
                            resolve([latitude, longitude]);
                        },
                        (error) => {
                            document.getElementById('status').textContent = `Error fetching location: ${error.message}`;
                            reject(`Error fetching location: ${error.message}`);
                        }
                    );
                } else {
                    document.getElementById('status').textContent = 'Geolocation is not supported by this browser.';
                    reject('Geolocation is not supported by this browser.');
                }
            });
        }

        function createPromise() {
            // 여기서 약속 장소를 생성하는 데 필요한 정보를 기입하는 html form 태그 생성하기
            // 팝업창의 URL과 특성을 설정합니다.
            const popupContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>약속 생성</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; }
                        p { font-size: 14px; }
                        .input-container { margin-bottom: 15px; font-size: 20px; }
                        input { display: block; width: 200px; padding: 8px; margin-top: 5px; }
                    </style>
                </head>
                <body>
                    <h1>약속 생성</h1>
                    <div class="input-container">
                        <label for="promiseName">약속 이름을 입력하세요.</label>
                        <input type="text" id="promiseName">
                    </div>
                    <div class="input-container">
                        <label for="maxParticipants">최대 인원 수를 입력하세요.</label>
                        <input type="number" id="maxParticipants">
                    </div>
                    <button onclick="window.close()">Close Popup</button>
                </body>
                </html>
            `;

            // 팝업창을 엽니다.
            const popupWindow = window.open('', 'PopupWindow', 'width=400,height=300');

            // 팝업창의 문서에 내용을 작성합니다.
            popupWindow.document.write(popupContent);
            popupWindow.document.close();
        }

        function addMarker(latitude, longitude, username, userText) {
            const markerPosition = new kakao.maps.LatLng(latitude, longitude);
            const marker = new kakao.maps.Marker({
                position: markerPosition,
                map: map
            });

            const iwContent = `
                <div style="padding:10px; 
                            width: 430px; 
                            height: 150px; 
                            display: flex; 
                            flex-direction: column; 
                            align-items: center; 
                            justify-content: center; 
                            margin-top: 20px;
                            font-size: 40px;">` + userText + '약속을 생성하시겠습니까?' + `
                
                    <br>
                    <button style="padding: 10px 20px; font-size: 25px; margin-top: 30px; margin-bottom: 10px;" onclick="createPromise()">네</button>
                </div>  
            `;
            const infowindow = new kakao.maps.InfoWindow({
                content: iwContent,
                removable: true
            });
            infowindow.open(map, marker);

            const key = `${username}_${latitude}_${longitude}`;
            userMarkers[key] = marker;
            userInfoWindows[key] = infowindow;
        }

        kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
            var latlng = mouseEvent.latLng;
            if (marker) {
                marker.setMap(null);
            }
            if (infowindow) {
                infowindow.close();
            }
            marker = new kakao.maps.Marker({
                position: latlng,
                map: map
            });

            var userText = document.getElementById('markerText').value;

            const markerInfo = {
                action: 'addMarker',
                latitude: latlng.getLat(),
                longitude: latlng.getLng(),
                username: username,
                userText: userText
            };

            socket.send(JSON.stringify(markerInfo));

            var message = ''
            
            var resultDiv = document.getElementById('clickLatlng');
            resultDiv.innerHTML = message;
        });
    </script>
</body>
</html>