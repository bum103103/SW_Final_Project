<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kakao Map</title>
    <style>
        #map {
            width: 500px;
            height: 400px;
        }
        #userInfo {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="userInfo"></div>
    <div id="map"></div>
    <p><em>지도를 클릭해주세요!</em></p>
    <div id="clickLatlng"></div>
    <input type="text" id="markerText" placeholder="마커에 표시할 텍스트를 입력하세요">
    <!--USERNAME-->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=53644151cc4f34401c8eef39c8923729"></script>
    <script>
        var username = null; // 로그인 이름과 동적 연결

        document.addEventListener('DOMContentLoaded', function () {
            fetch('/get-username')
                .then(response => response.json())
                .then(data => {
                    if (data.username) {
                        console.log("Logged in as:", data.username);
                        username = data.username;
                        initializeMap(); // username이 정의된 후 initializeMap 호출
                        initializeChat();
                    }
                })
                .catch(error => console.error('Error fetching username:', error));
        });

        // WebSocket 연결 초기화
        var socket = new WebSocket(`wss://${window.location.host}`);

        socket.onopen = function () {
            console.log('WebSocket 연결 성공');
        };

        socket.onerror = function (error) {
            console.log('WebSocket 에러:', error);
        };

        socket.onclose = function () {
            console.log('WebSocket 연결 종료');
        };

        let userMarkers = {};
        let userInfoWindows = {};

        socket.onmessage = function (event) {
            const message = JSON.parse(event.data);
            if (message.action === 'updateUserLocations') {
                updateUserMarkers(message.userLocations);
            } else if (message.action === 'removeMarker') {
                removeUserMarker(message.username, message.latitude, message.longitude);
            } else if (message.action === 'addMarker') {
                addMarker(message.latitude, message.longitude, message.username, message.userText);
            }
        };

        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };
        var map = new kakao.maps.Map(container, options);
        var marker = null;
        var infowindow = null;

        console.log('로그인한 사용자:', username);

        var userInfoDiv = document.getElementById('userInfo');
        userInfoDiv.innerHTML = username + '님이 접속했습니다.';

        let userLatitude = 0.0;
        let userLongitude = 0.0;

        function initializeMap() {
            getUserGeoData()
                .then(([latitude, longitude]) => {
                    userLatitude = latitude;
                    userLongitude = longitude;
                    console.log(`Initial Latitude: ${userLatitude}, Longitude: ${userLongitude}`);

                    map.setCenter(new kakao.maps.LatLng(userLatitude, userLongitude));

                    if (username) {
                        addOrUpdateUserMarker(username, userLatitude, userLongitude);
                    }

                    setInterval(updateUserLocation, 5000);
                })
                .catch((error) => {
                    console.error(error);
                });
        }

        function addOrUpdateUserMarker(username, latitude, longitude) {
            if (userMarkers[username]) {
                userMarkers[username].setPosition(new kakao.maps.LatLng(latitude, longitude));
            } else {
                userMarkers[username] = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(latitude, longitude),
                    map: map
                });

                var iwContent = `<div id="${username}-popup"><strong>${username}'s location</strong><br><div class="messages"></div></div>`;
                var infowindow = new kakao.maps.InfoWindow({
                    content: iwContent,
                    removable: true
                });
                infowindow.open(map, userMarkers[username]);
            }
        }

        function updateUserMarkers(userLocations) {
            userLocations.forEach(userLocation => {
                addOrUpdateUserMarker(userLocation.username, userLocation.latitude, userLocation.longitude);
            });
        }

        function removeUserMarker(username, latitude, longitude) {
            const key = `${username}_${latitude}_${longitude}`;
            if (userMarkers[key]) {
                userMarkers[key].setMap(null);
                delete userMarkers[key];
            }
            if (userInfoWindows[key]) {
                userInfoWindows[key].close();
                delete userInfoWindows[key];
            }
        }

        function sendLocation(latitude, longitude) {
            if (socket.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    action: 'updateLocation',
                    username: username,
                    latitude: latitude,
                    longitude: longitude
                });
                socket.send(message);
                console.log('위치 데이터 전송:', message);
            } else {
                console.log("WebSocket이 열려있지 않습니다.");
            }
        }

        function updateUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    if (username) {
                        sendLocation(latitude, longitude);
                    }
                }, error => {
                    console.error('위치 정보 에러:', error);
                });
            } else {
                console.error('이 브라우저에서는 위치 정보를 지원하지 않습니다.');
            }
        }

        function getUserGeoData() {
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const latitude = position.coords.latitude;
                            const longitude = position.coords.longitude;
                            resolve([latitude, longitude]);
                        },
                        (error) => {
                            document.getElementById('status').textContent = `Error fetching location: ${error.message}`;
                            reject(`Error fetching location: ${error.message}`);
                        }
                    );
                } else {
                    document.getElementById('status').textContent = 'Geolocation is not supported by this browser.';
                    reject('Geolocation is not supported by this browser.');
                }
            });
        }

        function addMarker(latitude, longitude, username, userText) {
            const markerPosition = new kakao.maps.LatLng(latitude, longitude);
            const marker = new kakao.maps.Marker({
                position: markerPosition,
                map: map
            });

            const iwContent = '<div style="padding:5px;">' + userText + ' (' + username + ')' + '</div>';
            const infowindow = new kakao.maps.InfoWindow({
                content: iwContent,
                removable: true
            });
            infowindow.open(map, marker);

            const key = `${username}_${latitude}_${longitude}`;
            userMarkers[key] = marker;
            userInfoWindows[key] = infowindow;
        }

        kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
            var latlng = mouseEvent.latLng;
            if (marker) {
                marker.setMap(null);
            }
            if (infowindow) {
                infowindow.close();
            }
            marker = new kakao.maps.Marker({
                position: latlng,
                map: map
            });

            var userText = document.getElementById('markerText').value;

            const markerInfo = {
                action: 'addMarker',
                latitude: latlng.getLat(),
                longitude: latlng.getLng(),
                username: username,
                userText: userText
            };

            socket.send(JSON.stringify(markerInfo));

            var message = '클릭한 위치의 위도는 ' + latlng.getLat() + ' 이고, ';
            message += '경도는 ' + latlng.getLng() + ' 입니다';
            var resultDiv = document.getElementById('clickLatlng');
            resultDiv.innerHTML = message;
        });
    </script>
</body>
</html>